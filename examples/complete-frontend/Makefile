# EDPMT Complete Frontend Makefile
# Provides simple commands to run the complete visual programming and peripheral control solution

.PHONY: help install run dev stop clean test setup check-deps

# Default target
help:
	@echo "EDPMT Complete Frontend - Visual Programming & Peripheral Control"
	@echo "================================================================="
	@echo ""
	@echo "Available commands:"
	@echo "  make install     - Install dependencies and setup environment"
	@echo "  make run         - Run complete solution (production mode)"
	@echo "  make dev         - Run in development mode with simulators (dynamic ports)"
	@echo "  make setup       - Create example projects and setup directories"
	@echo "  make test        - Test the frontend and backend integration"
	@echo "  make check-deps  - Check if all dependencies are installed"
	@echo "  make stop        - Stop running servers"
	@echo "  make clean       - Clean temporary files and logs"
	@echo ""
	@echo "Quick start:"
	@echo "  1. make install"
	@echo "  2. make dev"
	@echo "  3. Open http://localhost:$(HTTP_PORT) in your browser (dynamic port)"
	@echo ""

# Variables
PYTHON := python3
PIP := pip3
PORT_MANAGER := port_manager.py
SERVER_SCRIPT := server.py
LOG_DIR := logs
PROJECTS_DIR := projects
STATIC_DIR := static

# Load environment variables from .env (for display purposes)
-include .env
export

# Default ports (will be overridden by .env after allocation)
HTTP_PORT ?= 8085
WEBSOCKET_PORT ?= 8085

# Check if dependencies are installed
check-deps:
	@echo "ðŸ” Checking dependencies..."
	@[ -f requirements.txt ] || (echo "âŒ requirements.txt not found. Cannot check dependencies." && exit 1)
	@$(PYTHON) -c "import pkg_resources; [pkg_resources.require(r) for r in open('requirements.txt', 'r').read().splitlines() if r and not r.startswith('#')]" 2>/dev/null || \
		(echo "âŒ Missing Python dependencies. Run 'make install' first." && exit 1)
	@$(PYTHON) -c "import sys; sys.path.insert(0, '../..'); import edpmt" 2>/dev/null || \
		(echo "âŒ EDPMT not found. Please install EDPMT first." && exit 1)
	@command -v curl >/dev/null 2>&1 || (echo "âŒ 'curl' is required for health checks" && exit 1)
	@echo "âœ… All dependencies are available"

# Install dependencies using requirements.txt
install:
	@echo "ðŸ“¦ Installing dependencies from requirements.txt..."
	@$(PIP) install --user --break-system-packages -r requirements.txt
	@echo "ðŸ—ï¸  Checking EDPMT..."
	@$(PYTHON) -c "import sys; sys.path.insert(0, '../..'); import edpmt; print('âœ… EDPMT available')" || \
		(echo "Installing EDPMT in editable mode..." && cd ../.. && $(PIP) install --user -e .)
	@echo "âœ… Installation check completed successfully"

# Setup directories and example projects
setup:
	@echo "ðŸ—ï¸  Setting up directories and example projects..."
	@mkdir -p $(LOG_DIR)
	@mkdir -p $(PROJECTS_DIR)
	@echo "ðŸ“ Created directories: $(LOG_DIR), $(PROJECTS_DIR)"
	@$(PYTHON) -c "import json; \
		projects = [ \
			{'name': 'LED Blink', 'description': 'Simple LED blinking pattern', 'blocks': [{'type': 'start', 'position': {'x': 50, 'y': 50}, 'params': {}}, {'type': 'loop', 'position': {'x': 200, 'y': 50}, 'params': {'count': 10}}, {'type': 'gpio-output', 'position': {'x': 350, 'y': 50}, 'params': {'pin': 18, 'value': '1'}}, {'type': 'delay', 'position': {'x': 500, 'y': 50}, 'params': {'duration': 500}}, {'type': 'gpio-output', 'position': {'x': 650, 'y': 50}, 'params': {'pin': 18, 'value': '0'}}, {'type': 'delay', 'position': {'x': 800, 'y': 50}, 'params': {'duration': 500}}], 'version': '1.0'}, \
			{'name': 'Button Monitor', 'description': 'Monitor button presses and control LED', 'blocks': [{'type': 'start', 'position': {'x': 50, 'y': 50}, 'params': {}}, {'type': 'gpio-input', 'position': {'x': 200, 'y': 50}, 'params': {'pin': 2, 'mode': 'pull-up'}}, {'type': 'condition', 'position': {'x': 350, 'y': 50}, 'params': {'operator': '==', 'value': '0'}}, {'type': 'gpio-output', 'position': {'x': 500, 'y': 30}, 'params': {'pin': 18, 'value': '1'}}, {'type': 'gpio-output', 'position': {'x': 500, 'y': 90}, 'params': {'pin': 18, 'value': '0'}}], 'version': '1.0'}, \
			{'name': 'Traffic Light', 'description': 'Three-LED traffic light sequence', 'blocks': [{'type': 'start', 'position': {'x': 50, 'y': 50}, 'params': {}}, {'type': 'loop', 'position': {'x': 200, 'y': 50}, 'params': {'infinite': True}}, {'type': 'gpio-output', 'position': {'x': 350, 'y': 30}, 'params': {'pin': 18, 'value': '1'}}, {'type': 'delay', 'position': {'x': 500, 'y': 30}, 'params': {'duration': 3000}}, {'type': 'gpio-output', 'position': {'x': 650, 'y': 30}, 'params': {'pin': 18, 'value': '0'}}, {'type': 'gpio-output', 'position': {'x': 350, 'y': 70}, 'params': {'pin': 19, 'value': '1'}}, {'type': 'delay', 'position': {'x': 500, 'y': 70}, 'params': {'duration': 1000}}, {'type': 'gpio-output', 'position': {'x': 650, 'y': 70}, 'params': {'pin': 19, 'value': '0'}}, {'type': 'gpio-output', 'position': {'x': 350, 'y': 110}, 'params': {'pin': 20, 'value': '1'}}, {'type': 'delay', 'position': {'x': 500, 'y': 110}, 'params': {'duration': 3000}}, {'type': 'gpio-output', 'position': {'x': 650, 'y': 110}, 'params': {'pin': 20, 'value': '0'}}], 'version': '1.0'} \
		]; \
		[open(f'$(PROJECTS_DIR)/{p[\"name\"].replace(\" \", \"_\").lower()}.json', 'w').write(json.dumps(p, indent=2)) for p in projects]"
	@echo "âœ… Setup completed - example projects created"

# Run in development mode (unified server serves static + WebSocket under /ws)
dev: stop check-deps test setup check-ports
	@HTTP_PORT=$(HTTP_PORT) PYTHON=$(PYTHON) SERVER_SCRIPT=$(SERVER_SCRIPT) LOG_DIR=$(LOG_DIR) bash scripts/dev.sh

# Check if target port is free (returns non-zero if busy)
check-ports:
	@HTTP_PORT=$(HTTP_PORT) bash scripts/check_ports.sh

# Stop development server
stop:
	@echo "ðŸ›‘ Stopping development server..."
	@pkill -f "$(SERVER_SCRIPT)" || echo "Server was not running."
	@echo "âœ… Server stopped."

# Clean temporary files
clean:
	@echo "ðŸ§¹ Cleaning up..."
	@rm -rf $(LOG_DIR)/*.log 2>/dev/null && echo "âœ… Cleared log files" || echo "â„¹ï¸  No log files to clean"
	@rm -rf __pycache__ 2>/dev/null && echo "âœ… Cleared Python cache" || echo "â„¹ï¸  No Python cache to clean"
	@rm -rf .pytest_cache 2>/dev/null && echo "âœ… Cleared test cache" || echo "â„¹ï¸  No test cache to clean"
	@find . -name "*.pyc" -delete 2>/dev/null && echo "âœ… Cleared Python bytecode" || echo "â„¹ï¸  No bytecode files found"
	@echo "âœ… Cleanup completed"

# Advanced targets for development

# Run with custom ports
run-custom:
	@read -p "HTTP port [8086]: " http_port; \
	read -p "WebSocket port [8086]: " ws_port; \
	$(PYTHON) $(SERVER_SCRIPT) \
		--http-port $${http_port:-8086} \
		--ws-port $${ws_port:-8086} \
		--hardware-simulators \
		--verbose

# Monitor logs in real-time
logs:
	@echo "ðŸ“„ Monitoring server logs (Ctrl+C to stop)..."
	@tail -f $(LOG_DIR)/server*.log 2>/dev/null || (echo "âŒ No log files found. Start the server first." && exit 1)

# Show server status
status:
	@echo "ðŸ” EDPMT Complete Frontend Status:"
	@echo "=================================="
	@pgrep -f "$(SERVER_SCRIPT)" >/dev/null && echo "ðŸŸ¢ Server: Running" || echo "ðŸ”´ Server: Stopped"
	@curl -s http://localhost:$(HTTP_PORT)/api/status >/dev/null 2>&1 && echo "ðŸŸ¢ HTTP API: Responsive" || echo "ðŸ”´ HTTP API: Not responding"
	@test -f $(LOG_DIR)/server*.log && echo "ðŸ“„ Logs: Available in $(LOG_DIR)/" || echo "ðŸ“„ Logs: None found"
	@test -d $(PROJECTS_DIR) && echo "ðŸ“ Projects: $(shell ls $(PROJECTS_DIR)/*.json 2>/dev/null | wc -l) projects available" || echo "ðŸ“ Projects: Directory not found"

# Create project backup
backup:
	@echo "ðŸ’¾ Creating project backup..."
	@backup_name="projects_backup_$(shell date +%Y%m%d_%H%M%S).tar.gz"; \
	tar -czf "$$backup_name" $(PROJECTS_DIR)/ $(LOG_DIR)/ 2>/dev/null && \
	echo "âœ… Backup created: $$backup_name" || \
	echo "âŒ Backup failed"

# Show quick reference
quick-ref:
	@echo "EDPMT Complete Frontend - Quick Reference"
	@echo "========================================"
	@echo ""
	@echo "ðŸš€ Start Development:  make dev"
	@echo "ðŸš€ Start Production:   make run"
	@echo "ðŸ›‘ Stop Servers:       make stop"
	@echo "ðŸ§ª Run Tests:          make test"
	@echo "ðŸ§¹ Clean Files:        make clean"
	@echo ""
	@echo "ðŸ“„ Frontend URL:       http://localhost:$(HTTP_PORT)"
	@echo "ðŸ”Œ WebSocket URL:      ws://localhost:$(HTTP_PORT)/ws"
	@echo "ðŸ“ Projects Dir:       $(PROJECTS_DIR)/"
	@echo "ðŸ“„ Logs Dir:           $(LOG_DIR)/"
	@echo ""
	@echo "ðŸ’¡ For help: make help"

# Docker support (bonus)
docker-build:
	@echo "ðŸ³ Building Docker image..."
	@docker build -t edpmt-frontend . || (echo "âŒ Docker build failed" && exit 1)
	@echo "âœ… Docker image built successfully"

docker-run:
	@echo "ðŸ³ Running Docker container..."
	@docker run -d -p $(HTTP_PORT):$(HTTP_PORT) -p $(WEBSOCKET_PORT):$(WEBSOCKET_PORT) \
		--name edpmt-frontend edpmt-frontend || \
		(echo "âŒ Docker run failed" && exit 1)
	@echo "âœ… Docker container started"
	@echo "ðŸ“„ Frontend: http://localhost:$(HTTP_PORT)"

docker-stop:
	@echo "ðŸ³ Stopping Docker container..."
	@docker stop edpmt-frontend 2>/dev/null && docker rm edpmt-frontend 2>/dev/null || true
	@echo "âœ… Docker container stopped"

# Show all available targets
targets:
	@echo "Available Makefile targets:"
	@echo "=========================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) 2>/dev/null || \
	grep -E '^[a-zA-Z_-]+:' $(MAKEFILE_LIST) | grep -v '^#' | sed 's/:.*//g' | sort

# Test the complete solution (starts a temporary server and probes endpoints)
test: check-deps
	@PYTHON=$(PYTHON) SERVER_SCRIPT=$(SERVER_SCRIPT) LOG_DIR=$(LOG_DIR) bash scripts/test.sh

# Continuous monitoring: check endpoints every 5s and tail logs
monitor:
	@HTTP_PORT=$(HTTP_PORT) LOG_DIR=$(LOG_DIR) bash scripts/monitor.sh

# Start dev then monitor continuously
dev-watch: dev monitor
